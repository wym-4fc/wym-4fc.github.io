<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>a.md | 蛋疼的@4FC</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">a.md</h1><a id="logo" href="/.">蛋疼的@4FC</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">a.md</h1><div class="post-meta"><a href="/2018/08/31/a-md/#comments" class="comment-count"></a><p><span class="date">Aug 31, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h1 id="data-guard-搭建"><a href="#data-guard-搭建" class="headerlink" title="data guard 搭建"></a>data guard 搭建</h1><table>
<thead>
<tr>
<th>步骤</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>Step1</td>
<td>准备工作</td>
</tr>
<tr>
<td>Step2</td>
<td>主库参数配置</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h2><p>主库 rdbms+dbca,备库 rdbms</p>
<hr>
<h2 id="2-主库参数配置"><a href="#2-主库参数配置" class="headerlink" title="2.主库参数配置"></a>2.主库参数配置</h2><p>主库参数配置包括归档、orce_logging是否打开,主库参数文件、网络连接串等文件配置</p>
<h3 id="2-1-归档开启"><a href="#2-1-归档开启" class="headerlink" title="2.1 归档开启"></a>2.1 归档开启</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">open状态下</span><br><span class="line">SQL&gt; archive log list</span><br><span class="line">Database log mode              Archive Mode</span><br><span class="line">Automatic archival             Enabled</span><br><span class="line">Archive destination            /oracle/app/product/11.2.0/db_1/dbs/arch</span><br><span class="line">Oldest online log sequence     185</span><br><span class="line">Next log sequence to archive   187</span><br><span class="line">Current log sequence           187</span><br></pre></td></tr></table></figure>
<p>如果没有开启参考以下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount状态下</span><br><span class="line">SQL&gt; alter database archivelog;</span><br><span class="line">Database altered.</span><br></pre></td></tr></table></figure></p>
<h3 id="2-2-force-logging-开启"><a href="#2-2-force-logging-开启" class="headerlink" title="2.2 force_logging 开启"></a>2.2 force_logging 开启</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select force_logging from v$database;</span><br><span class="line">FOR</span><br><span class="line">---</span><br><span class="line">YES</span><br></pre></td></tr></table></figure>
<p>状态如果为YES则为开启状态，如果状态为NO，参考以下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; alter database force logging;</span><br><span class="line">Database altered.</span><br></pre></td></tr></table></figure>
<h3 id="2-3-添加网络连接串"><a href="#2-3-添加网络连接串" class="headerlink" title="2.3 添加网络连接串"></a>2.3 添加网络连接串</h3><p>网络连接串用于连接主备两端数据库，用户传输归档等作用，单机环境配置如下几个：生产端、备端，详细配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vi $ORACLE_HOME/network/admin/tnsnames.ora</span><br><span class="line">//生产端</span><br><span class="line">DG =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS_LIST =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.153.145)(PORT = 1521))</span><br><span class="line">    )</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SERVICE_NAME = dg)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">//备端</span><br><span class="line">DG_STD =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS_LIST =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.153.146)(PORT = 1521))</span><br><span class="line">    )</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SERVICE_NAME = dg)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"> //DG指主库服务名   service_name指主库实例名   host为主库IP</span><br></pre></td></tr></table></figure>
<h3 id="2-4-修改主库参数文件"><a href="#2-4-修改主库参数文件" class="headerlink" title="2.4 修改主库参数文件"></a>2.4 修改主库参数文件</h3><p>修改前备份参数文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; create pfile=&apos;/tmp/initorcl.ora_20180830.bak&apos; from spfile;</span><br></pre></td></tr></table></figure></p>
<p>参数设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">调整固定日志切换频率为300秒/5分钟</span><br><span class="line">SQL&gt; alter system set archive_lag_target=300 scope=both;</span><br><span class="line">设置本地归档路径</span><br><span class="line">SQL&gt; alter system set log_archive_dest_1=&apos;location=/arch&apos; scope=both;</span><br><span class="line">设置备库归档路径</span><br><span class="line">SQL&gt;ALTER SYSTEM SET log_archive_dest_2=&apos;service=dg_std arch async VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=dg&apos; SCOPE=BOTH;</span><br><span class="line">//service指备库服务名(tnsnames.ora中设置)，DB_UNIQUE_NAME指备库实例名</span><br><span class="line"></span><br><span class="line">应用归档路径</span><br><span class="line">SQL&gt;ALTER SYSTEM set LOG_ARCHIVE_DEST_STATE_1=ENABLE SCOPE=BOTH;</span><br><span class="line">SQL&gt;ALTER SYSTEM set LOG_ARCHIVE_DEST_STATE_2=ENABLE SCOPE=BOTH;</span><br><span class="line"></span><br><span class="line">设m换参数</span><br><span class="line">SQL&gt;ALTER SYSTEM set FAL_SERVER=&apos;dg&apos; SCOPE=BOTH;</span><br><span class="line">SQL&gt;ALTER SYSTEM set FAL_CLIENT=&apos;dg_std&apos; SCOPE=BOTH;</span><br><span class="line"></span><br><span class="line">备库数据文件自动管理</span><br><span class="line">SQL&gt;ALTER SYSTEM SET STANDBY_FILE_MANAGEMENT =AUTO/MANUAL  SCOPE=both;(自动、手动模式)</span><br><span class="line"></span><br><span class="line">//罗列所有DB_UNIQUE_NAME</span><br><span class="line">SQL&gt;alter system set log_archive_config=&quot;DG_CONFIG=(orcl,orcl_dg)&quot; scope=both sid=&apos;*&apos;;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-5-创建Standby-Redo-Log组数"><a href="#2-5-创建Standby-Redo-Log组数" class="headerlink" title="2.5 创建Standby Redo Log组数"></a>2.5 创建Standby Redo Log组数</h3><p>standby redo log 作用在备库，用于接收从主库传过来的日志信息，在主库部署主要是为了方便日后的主备切换<br>创建适当数量的Standby Redo Log组数</p>
<p>  公式如下：</p>
<ol>
<li>如果主库是单实例数据库：Standby Redo Log组数=主库日志组总数+1</li>
<li>如果主库是RAC数据库：Standby Redo Log组数=(所有节点中日志组数最大值 + 1) * RAC节点数 </li>
<li>大小和生产库redo日志组大小一致</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter database add logfile group 1 &apos;/oracle/app/oradata/dg/redo01.log&apos; size 200m;</span><br><span class="line">alter database add logfile group 2 &apos;/oracle/app/oradata/dg/redo02.log&apos; size 200m;</span><br></pre></td></tr></table></figure>
<h2 id="3-创建备库参数文件并传送到备库"><a href="#3-创建备库参数文件并传送到备库" class="headerlink" title="3 创建备库参数文件并传送到备库"></a>3 创建备库参数文件并传送到备库</h2><p>在根目录下创建相应目录，用来存放参数文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/tempfile/</span><br></pre></td></tr></table></figure>
<p>1.创建备库参数文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create pfile=&apos;/tmp/tempfile/&apos; from spfile;</span><br></pre></td></tr></table></figure></p>
<p>2.创建备库控制文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter database create standby controlfile as &apos;/tmp/tempfile/control01.ctl&apos;;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>拷贝文件到备库，在这之前先把数据库设置为bakup模式</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter database begin bakup</span><br></pre></td></tr></table></figure>
<p>3.拷贝参数文件到备库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /oracle/app/product/11.2.0/db_1/dbs/initdg.ora 192.168.153.146:/$ORACLE_HOME/dbs/</span><br></pre></td></tr></table></figure></p>
<p>4.拷贝控制文件到备库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /tmp/tempfile/control01.ctl 192.168.153.146:/oracle/app/oradata/dg/</span><br></pre></td></tr></table></figure></p>
<p>5.拷贝密码文件到备库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /oracle/app/product/11.2.0/db_1/dbs/orapwdg 192.168.153.146:/$ORACLE_HOME/dbs/</span><br></pre></td></tr></table></figure>
<p>6.拷贝数据文件到备库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /oracle/app/oradata/dg/*.dbf 192.168.153.146:/oracle/app/oradata/dg/</span><br></pre></td></tr></table></figure>
<p>7.拷贝tns文件到备库相同目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /oracle/app/product/11.2.0/db_1/network/admin/tnsnames.ora 192.168.153.146:/oracle/app/product/11.2.0/db_1/network/admin/</span><br></pre></td></tr></table></figure>
<blockquote>
<p>拷贝完关闭备份</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter database end backup</span><br></pre></td></tr></table></figure>
<h2 id="4-备库端设置"><a href="#4-备库端设置" class="headerlink" title="4.备库端设置"></a>4.备库端设置</h2><p>创建需要的文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /oracle/app/diag/rdbms/dg/dg</span><br><span class="line">mkdir -p /oracle/app/admin/dg</span><br></pre></td></tr></table></figure>
<p>修改参数文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi $ORACLE_HOME/dbs/initdg.ora</span><br><span class="line">*.log_archive_dest_2=&apos;SERVICE=dg arch ASYNC VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=dg&apos; </span><br><span class="line">*.control_files=&apos;/oradata/dg/control01.ctl&apos;(只有一个控制文件)</span><br></pre></td></tr></table></figure>
</div><div class="tags"></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2018/08/31/Data Guard(1)/" class="next"></a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#data-guard-搭建"><span class="toc-text">data guard 搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-准备工作"><span class="toc-text">1.准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-主库参数配置"><span class="toc-text">2.主库参数配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-归档开启"><span class="toc-text">2.1 归档开启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-force-logging-开启"><span class="toc-text">2.2 force_logging 开启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-添加网络连接串"><span class="toc-text">2.3 添加网络连接串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-修改主库参数文件"><span class="toc-text">2.4 修改主库参数文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-创建Standby-Redo-Log组数"><span class="toc-text">2.5 创建Standby Redo Log组数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-创建备库参数文件并传送到备库"><span class="toc-text">3 创建备库参数文件并传送到备库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-备库端设置"><span class="toc-text">4.备库端设置</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/31/a-md/">a.md</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/31/Data Guard(1)/">Data Guard(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/29/hello-world - 副本/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/27/hello-world/">hello-world</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">yongming wang.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>